# ---- builder ----
FROM timbru31/node-chrome:latest AS builder

WORKDIR /app

# Copy package files first (cache layers)
COPY package.json package-lock.json* ./

# Install deps
RUN npm ci --no-progress

# Copy source and build assets
COPY tsconfig.json ./
COPY src ./src
COPY static ./static
COPY config.json ./config.json

# Build
RUN npm run build

# ---- runtime ----
FROM timbru31/node-chrome:latest AS runner

WORKDIR /app

# Copy built app from builder
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/package-lock.json ./package-lock.json

# Install only production deps using lockfile
RUN npm ci --only=production --no-progress
COPY --from=builder /app/static ./static
COPY --from=builder /app/config.json ./config.json

# Expose port used by NestJS
ENV PORT=3001
ENV CONFIG_PATH=/app/config.json

# Start (assumes package.json has a `start:prod` script that runs node dist/main.js)
CMD ["npm", "run", "start:prod"]
