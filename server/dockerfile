# ---- client-builder ----
FROM node:18 AS client-builder

WORKDIR /client

# copy client package files first for layer caching
COPY client/package.json client/package-lock.json* ./

RUN npm ci --no-progress

# copy client source and build
COPY client/ .

# build the Vite React app (output to client/dist by default)
RUN npm run build

# ---- server-builder ----
FROM timbru31/node-chrome:latest AS server-builder

WORKDIR /app

# copy server package files first
COPY server/package.json server/package-lock.json* ./

# install server deps for build
RUN npm ci --no-progress

# copy server sources
COPY server/ .

# copy the built client (from client-builder) into the server build context
# we'll expose these static assets at runtime from /app/public
COPY --from=client-builder /client/dist ./public

# copy other static/config if you keep them in server/
# (optional; keep if you use /server/static or /server/config.json)
COPY server/static ./static
COPY server/config.json ./config.json

# build Nest server to /app/dist
RUN npm run build

# ---- runtime ----
FROM timbru31/node-chrome:latest AS runner

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3001
ENV CONFIG_PATH=/app/config.json

# copy compiled server
COPY --from=server-builder /app/dist ./dist
COPY --from=server-builder /app/package.json ./package.json
COPY --from=server-builder /app/package-lock.json ./package-lock.json

# copy static/public (client build) and other static assets
COPY --from=server-builder /app/public ./public
COPY --from=server-builder /app/static ./static
COPY --from=server-builder /app/config.json ./config.json

# install only production deps
RUN npm ci --only=production --no-progress

EXPOSE 3001

# start app (expects a start:prod script that runs node dist/main.js)
CMD ["npm", "run", "start:prod"]